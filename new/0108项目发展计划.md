# Wasteland Survivor 项目开发行动纲领

> 更新时间：2026-01-09
> 项目目录：`D:\Code\fallout_roguelike`
> 远程仓库：https://github.com/keithhegit/fallout_roguelite

---

## 0. 执行摘要（TL;DR）

**项目目标**：将修仙文字 RPG 换皮为 Fallout 风格竖屏 H5（PWA），面向西方市场，部署至 Cloudflare Pages。

**当前状态**：
- ✅ 移动端骨架、PWA、英文 locales 基础已落地
- ✅ 废土 UI 主题方向已确立（Pip-Boy/CRT 风格）
- ✅ 部署链路可用（GitHub Actions → Cloudflare Pages）
- ✅ **服务层中文硬编码已修复**（`randomService.ts` 全量废土化）
- ✅ **地点/秘境系统更新**（13 个地点已实装美术素材，词库已扩充至 50+）
- ✅ **全量英文化完成**（UI、注释、逻辑兼容键值均已清理）
- ⚠️ 部分组件风格未统一（仍需清理旧主题 class）

**下一阶段关键任务**：
1. **Turn-Based Battle 与 Inventory 的视觉一致性**（优先级 P1）
2. **清理残留旧主题 class**（`mystic-gold` 等），统一 design tokens
3. **补充剩余地点美术素材**（约 40+ 地点待制图）
4. **结构化日志升级**（将纯文本日志优化为可读性更高的卡片/列表）

---

## 1. 技术栈与工程现状

### 1.1 核心技术栈

| 类别 | 技术 | 版本 |
|------|------|------|
| 前端框架 | React + TypeScript | 19.2 / 5.8 |
| 构建工具 | Vite | 6.2 |
| 样式方案 | Tailwind CSS | 4.x |
| PWA | vite-plugin-pwa + workbox | 1.2 / 7.4 |
| 状态管理 | React Hooks + localStorage | - |
| 部署平台 | Cloudflare Pages | - |

### 1.2 项目结构速览

```
fallout_roguelike/
├── App.tsx                 # 应用主入口（1700+ 行，核心逻辑聚合）
├── index.tsx               # React DOM 挂载点
├── index.html              # HTML 模板（含 viewport、字体、importmap）
├── index.css               # 全局样式
├── components/             # UI 组件（Modal/Panel 为主）
├── views/                  # 业务视图层（handlers + 页面组件）
├── constants/              # 游戏数据常量（境界/物品/宠物等）
├── services/               # 服务层（AI事件/战斗/商店规则）
├── hooks/                  # 自定义 Hooks
├── context/                # React Context（Locale/UI）
├── utils/                  # 工具函数
├── locales/en/             # 英文翻译文件（8 个 JSON）
├── public/assets/          # 静态资源
├── new/                    # 规划文档（本文件所在目录）
└── .github/workflows/      # CI/CD 配置
```

### 1.3 本地开发命令

```bash
pnpm install          # 安装依赖
pnpm dev              # 启动开发服务器
pnpm build            # 生产构建
pnpm preview          # 本地预览生产构建
pnpm lint             # ESLint 检查
pnpm lint:fix         # ESLint 自动修复
```

### 1.4 部署配置

**GitHub Actions 自动部署**（主路径）：
- Workflow: `.github/workflows/deploy.yml`
- 触发条件：push 到 `main`/`master` 或手动触发
- 部署命令：`wrangler pages deploy dist --project-name=wasteland-survivor`

**所需 Secrets/Vars**：
| 名称 | 类型 | 说明 |
|------|------|------|
| `CLOUDFLARE_API_TOKEN` | Secret | Cloudflare API Token |
| `CLOUDFLARE_ACCOUNT_ID` | Secret | Cloudflare Account ID |
| `VITE_AI_KEY` | Secret | AI 服务 API Key |
| `VITE_AI_PROVIDER` | Var | AI 提供商（glm/siliconflow/openai） |

---

## 2. 已完成工作清单

### 2.1 基础设施 ✅

| 模块 | 状态 | 关键文件 |
|------|------|---------|
| 移动端 viewport | ✅ | `index.html` |
| PWA manifest | ✅ | `vite.config.ts` |
| Service Worker | ✅ | vite-plugin-pwa 自动生成 |
| CRT 视觉效果 | ✅ | `components/CRTOverlay.tsx` |
| 废土主题色 | ✅ | `tailwind.config.js` |
| i18n 基础架构 | ✅ | `context/LocaleContext.tsx` |
| 英文翻译文件 | ✅ | `locales/en/*.json`（8 个文件） |
| 资源常量化 | ✅ | `constants/assets.ts` |
| CI/CD 流水线 | ✅ | `.github/workflows/deploy.yml` |

### 2.2 组件终端化（部分完成）

| 组件 | 状态 | 说明 |
|------|------|------|
| AutoAdventureConfigModal | ✅ | 扫描线/术语/按钮统一 |
| BattleModal | ✅ | 日志展示与状态区统一 |
| CRTOverlay | ✅ | 全局材质层 |
| SecretRealmModal | ✅ | 地点卡片、风险分级、美术素材支持 |
| TurnBasedBattleModal | ✅ | 已移除 mystic-gold，待进一步优化 |
| InventoryModal | ✅ | 已移除 mystic-gold，待进一步优化 |
| BatchUseModal | ✅ | 文本已本地化 |
| BatchFeedModal | ✅ | 文本已本地化 |
| GlobalChat | ✅ | 文本已本地化，Emoji 优化 |
| WelcomeScreen | ✅ | 文本已本地化 |
| 其他 Modal | ⚠️ | 风格不统一，需进一步排查 |

---

## 3. 潜在崩溃问题分析 🔴

### 3.1 [已修复] ASSETS 未定义导致黑屏

**问题**：生产构建后运行黑屏，控制台报 `ReferenceError: ASSETS is not defined`

**原因**：部分组件使用了 `ASSETS` 常量但未导入

**修复状态**：✅ 已修复，27 个组件已正确导入

**验证方法**：
```bash
# 检查是否所有使用 ASSETS 的组件都已导入
grep -r "ASSETS\." components/ --include="*.tsx" | grep -v "import.*ASSETS"
# 应返回空结果
```

### 3.2 [已修复] workbox-window 依赖缺失

**问题**：PWA 构建/注册相关流程缺依赖导致构建失败

**修复状态**：✅ 已在 `devDependencies` 中添加 `workbox-window: ^7.4.0`

### 3.3 [待评估] index.html importmap 潜在冲突

**问题描述**：`index.html` 第 30-40 行存在外部 CDN importmap：

```html:30:40:index.html
<script type="importmap">
  {
    "imports": {
      "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
      "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
      "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
      "react/": "https://aistudiocdn.com/react@^19.2.0/",
      "react": "https://aistudiocdn.com/react@^19.2.0"
    }
  }
</script>
```

**风险分析**：
- **开发环境**：Vite dev server 优先使用 node_modules，importmap 被忽略
- **生产环境**：Vite 打包时会 bundle 所有依赖，importmap 理论上不生效
- **潜在问题**：如果浏览器先解析 importmap，可能导致模块加载冲突

**建议处理**：
```html
<!-- 方案 A：删除整个 importmap（推荐） -->
<!-- 方案 B：保留但添加条件注释 -->
```

**验证方法**：
```bash
pnpm build && pnpm preview
# 打开浏览器 DevTools → Network，检查是否有从 aistudiocdn.com 加载的请求
# 如果没有，说明 importmap 未生效，可以安全删除
```

### 3.4 [已修复] 服务层中文硬编码 �

**问题描述**：`services/randomService.ts` 中曾存在大量中文字符串，现已全部修复。

**修复状态**：
- `REALM_NAMES_BY_RISK`：✅ 全量废土化，扩展至 50+ 地点
- `REALM_DESCRIPTIONS_BY_RISK`：✅ 全量英文化
- `DROP_ITEMS`：✅ 全量废土化
- `SECT_DATA`：✅ 18 派系全量废土化
- `TASK_NAMES_BY_TYPE`：✅ 28 任务类型全量废土化
- `TASK_DESCRIPTIONS_BY_TYPE`：✅ 全量废土化
- `ITEM_POOLS`：✅ 全量废土化

---

## 4. 待办事项详细方案

### 4.1 P0 - 阻塞性问题（已完成）

#### 4.1.1 修复 randomService.ts 中文内容 ✅
- 已完成 18 个派系、28 种任务类型、所有掉落物和地点的英文化与废土化重写。
- 已实装 `REALM_ASSETS` 支持，目前覆盖 13 个核心地点。

#### 4.1.2 验证 ASSETS 导入完整性 ✅
- 所有组件已正确导入。

---

### 4.2 P1 - 高优先级（用户体验关键）

#### 4.2.1 Turn-Based Battle 终端化
- **状态**：初步清理完成，需进一步打磨。
- **任务**：
    - [x] 检查战斗日志滚动体验
    - [x] 优化伤害数字显示效果（暴击、闪避等）
    - [ ] 确保技能名称与描述完全英文化

#### 4.2.2 Inventory/Equipment 物品卡体系
- **状态**：初步清理完成。
- **任务**：
    - [x] 统一稀有度边框颜色（Common/Rare/Legendary/Mythic）
    - [ ] 优化装备对比提示（Compare Tooltip）
    - [ ] 确保所有物品描述无中文残留

#### 4.2.3 旧主题 Class 全局清理
- **当前状态**：已全局替换 `mystic-gold`, `mystic-jade`, `mystic-blood` 为废土色系。
- **剩余工作**：
    - [x] 扫描 `components/ShopModal.tsx`
    - [x] 扫描 `components/CharacterModal.tsx`
    - [x] 扫描 `components/CultivationModal.tsx`
    - [x] 批量替换为 `amber-400`, `toxic-500`, `rust-500` 等废土色系。

---

### 4.3 P2 - 中优先级（质量门禁）

#### 4.3.1 ESLint 警告清零
- **当前状态**：待处理。
- **计划**：
    - 运行 `pnpm lint`
    - 修复 `no-unused-vars`
    - 修复 `prefer-const`

#### 4.3.2 i18n 完整性检查
- **当前状态**：✅ 已完成。
- **成果**：
    - 全量扫描 `*.ts` / `*.tsx` 文件，确认无中文字符残留。
    - 修复了 `BatchUseModal` 等组件中的硬编码中文逻辑。
    - 清理了 `utils` 目录下的中文兼容 Key。

---

### 4.4 P3 - 低优先级（锦上添花）

#### 4.4.1 结构化日志展示
将"纯文字日志堆叠"升级为"可扫描的结构化卡片"。

#### 4.4.2 掉落/升级动效
稀有度闪烁效果、拾取弹出条动画。

#### 4.4.3 中文 locale 支持
创建 `locales/zh/` 目录，支持双语切换。

---

## 5. 开发优先级矩阵

| 优先级 | 任务 | 预计工时 | 阻塞关系 | 状态 |
|-------|------|---------|---------|---|
| **P0** | randomService 中文修复 | 2-3h | 阻塞上线 | ✅ 完成 |
| **P0** | ASSETS 导入验证 | 30min | 阻塞上线 | ✅ 完成 |
| **P0** | 地点美术素材实装 | 1h | - | ✅ 完成 (13/50) |
| **P1** | TurnBasedBattle 终端化 | 2h | - | 🔄 进行中 |
| **P1** | Inventory 物品卡体系 | 3h | - | 🔄 进行中 |
| **P1** | 旧主题 class 清理 | 2h | 依赖 P1 | ⚠️ 待办 |
| **P2** | ESLint 警告清零 | 2h | - | ⚠️ 待办 |
| **P2** | i18n 完整性检查 | 1h | 依赖 P0 | ✅ 完成 |
| **P3** | 结构化日志 | 4h | - | ⚠️ 待办 |
| **P3** | 动效增强 | 4h | - | ⚠️ 待办 |

---

## 6. 交接清单

### 6.1 环境变量配置
(同上，略)

### 6.2 冒烟测试流程
(同上，略)

### 6.3 部署验证
(同上，略)

---

## 7. 参考文档索引

| 文档 | 路径 | 说明 |
|-----|------|------|
| 架构说明 | `doc/ARCHITECTURE.md` | 系统架构设计 |
| 模块说明 | `doc/MODULES.md` | 代码模块划分 |
| 存档格式 | `doc/SAVE_FORMAT.md` | localStorage 数据结构 |
| 题材设计 | `new/题材改版翻译字典.md` | **唯一权威字典** (已更新 V1.0) |
| UI 计划 | `new/H5移动端UI与美术升级计划.md` | 移动端 UI 规范 |
| 工程计划 | `new/implementation_plan.md` | 实施阶段划分 |
| 美术资源 | `new/UI与美术素材列表.md` | CDN 资源 URL 清单 |

---

## 8. 版本历史

| 日期 | 版本 | 变更说明 |
|-----|------|---------|
| 2026-01-10 | v2.2 | 全量英文化完成 (UI/逻辑/注释)，移除中文兼容 Key |
| 2026-01-09 | v2.1 | 更新 randomService 修复状态，标记地点素材实装进度 |
| 2026-01-08 | v2.0 | 重构为详细开发行动纲领，增加 step-by-step 方案 |
| 2026-01-08 | v1.0 | 初版交接文档 |
